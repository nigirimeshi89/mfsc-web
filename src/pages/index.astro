---
// src/pages/index.astro
import Layout from "../layouts/Layout.astro";
import { client } from "../lib/microcms";
import type { MicroCMSListResponse } from "../lib/microcms";

// ▼ ニュースの型定義
type News = {
	id: string;
	title: string;
	date: string;
	url?: string;
	top_image?: { url: string };
};

// ▼ 1. ニュース一覧用（テキスト表示用）
// ★修正：「日付(date)」が入っている記事だけを取得（Invalid Date対策）
const response = await client.get<MicroCMSListResponse<News>>({
	endpoint: "news",
	queries: {
		fields: ["id", "title", "date", "url"],
		filters: "date[exists]", // ★ここが重要！
		limit: 5,
	},
});

// ▼ 2. スライドショー用画像の取得
// 「トップ用画像(top_image)」がある記事だけを抽出してスライドショー化
const sliderResponse = await client.get<MicroCMSListResponse<News>>({
	endpoint: "news",
	queries: {
		fields: ["top_image"],
		filters: "top_image[exists]",
		limit: 10,
	},
});

// ▼ Vegas.js形式に変換
const vegasImages = sliderResponse.contents.map((content) => ({
	// @ts-ignore
	src: content.top_image.url,
}));
---

<Layout title="MAIN">
	<div id="header-placeholder"></div>

	<section id="vidual-area">
		<div id="slider-area" class="bgextend bgRLextendTrigger">
			<div class="bgappearTrigger">
				<div id="slider"></div>
			</div>
		</div>

		<h2>
			<span class="js_typing">Modern Folk Song Club</span><br /><span
				class="js_typing">Information</span
			>
		</h2>
		<dl>
			<dt>Follow Us</dt>
			<dd>
				<ul>
					<li>
						<a href="https://x.com/momotenguitar"
							><svg
								width="20"
								height="20"
								viewBox="0 0 1200 1227"
								fill="none"
								xmlns="http://www.w3.org/2000/svg"
								><path
									d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"
									fill="white"></path></svg
							></a
						>
					</li>
					<li>
						<a href="https://www.instagram.com/mfsc_modern/?hl=ja"
							><img
								src="/img/main/ico_insta.svg"
								alt="Instagram"
							/></a
						>
					</li>
				</ul>
			</dd>
		</dl>
		<div class="scrolldown1"><span>Scroll</span></div>
	</section>

	<main id="main-area">
		<canvas id="audioSpectrumCanvas"></canvas>
		<section id="service">
			<h2 class="js_typing">Main</h2>
			<p class="service-lead">
				<span class="bgextend bgRLextendTrigger">
					<span class="bgappearTrigger"
						>MFSCの活動状況を随時アップロードしていきますm(__)m</span
					>
				</span>
			</p>

			<a href="/freshman" class="btnlinestretches2">新入生の皆様へ</a>

			<div class="service-area">
				<section class="bgextend bgLRextendTrigger">
					<div class="bgappearTrigger">
						<header><h3>GALLERY</h3><p>活動記録</p></header>
						<p>
							これまでに活動してきたライブ写真等を掲載しています。
						</p>
						<a href="/gallery" class="btnlinestretches2">More</a>
					</div>
				</section>

				<section class="bgextend bgLRextendTrigger">
					<div class="bgappearTrigger">
						<header><h3>SCHEDULE</h3><p>年間行事予定</p></header>
						<p>
							学内・学外のライブ予定、過去の予定を掲載しています。
						</p>
						<a href="/schedule" class="btnlinestretches2">More</a>
					</div>
				</section>
				<div class="service-img-wrapper bgextend bgLRextendTrigger">
					<div class="bgappearTrigger">
						<div class="service-img"></div>
					</div>
				</div>
			</div>
		</section>

		<div class="news-img-wrapper bgextend bgRLextendTrigger">
			<div class="bgappearTrigger"><div class="news-img"></div></div>
		</div>

		<section id="news">
			<h2 class="js_typing">News</h2>
			<div class="tab-area bgextend bgLRextendTrigger">
				<div class="bgappearTrigger">
					<ul class="tab">
						<li class="active"><a href="#topics">Topics</a></li>
					</ul>
					<div class="tab-choice-area">
						<div id="topics" class="area is-active">
							<ul id="news-list">
								{
									response.contents.map((news) => (
										<li>
											<time datetime={news.date}>
												{new Date(news.date)
													.toLocaleDateString(
														"ja-JP",
														{
															year: "numeric",
															month: "2-digit",
															day: "2-digit",
														},
													)
													.replace(/\//g, ".")}
											</time>
											{news.url ? (
												<a
													href={news.url}
													target="_blank"
													rel="noopener noreferrer"
												>
													{news.title}
												</a>
											) : (
												<span>{news.title}</span>
											)}
										</li>
									))
								}
							</ul>
						</div>
					</div>
				</div>
			</div>
		</section>
		<section id="contact"></section>
	</main>

	<script is:inline define:vars={{ vegasImages }}>
		// jQuery ($) を使わず、純粋なJSでロード完了を待ちます
		window.addEventListener("load", function () {
			// ロード完了後、jQueryが使えるかチェック
			if (typeof $ === "undefined" || typeof $.fn.vegas === "undefined") {
				console.error("Vegas or jQuery not loaded");
				return;
			}

			// デフォルト画像
			const defaultImages = [{ src: "/img/jpg/bg_main_01.jpg" }];

			// microCMSの画像があればそれを使い、なければデフォルトを使う
			const finalImages =
				vegasImages.length > 0 ? vegasImages : defaultImages;

			// ★ここにあった destroy は削除しました★

			// Vegasを開始
			$("#slider").vegas({
				overlay: false,
				transition: "blur",
				transitionDuration: 2000,
				delay: 10000,
				animationDuration: 20000,
				animation: "kenburns",
				slides: finalImages,
			});
		});
	</script>

	<style>
		/* ニュースリストのスタイル */
		#news-list {
			padding: 0;
			list-style: none;
			text-align: left !important;
		}

		#news-list li {
			padding: 15px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			justify-content: flex-start;
			gap: 5px;
		}

		#news-list time {
			font-size: 0.85rem;
			color: #aaa;
			font-family: "Oswald", sans-serif;
			letter-spacing: 0.05em;
			margin: 0;
			line-height: 1;
		}

		#news-list a,
		#news-list span {
			font-size: 1rem;
			line-height: 1.5;
			display: block;
			text-decoration: none;
			text-align: left;
			margin: 0;
			padding: 0;
			width: 100%;
		}

		#news-list a:hover {
			opacity: 0.7;
		}
	</style>
</Layout>
