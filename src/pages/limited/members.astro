---
// src/pages/limited/members.astro
import Layout from "../../layouts/Layout.astro";

// â–¼â–¼â–¼ å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ â–¼â–¼â–¼
import { client } from "../../lib/microcms";
import type { MicroCMSListResponse } from "../../lib/microcms";
import { getSchoolYear, normalizePart } from "../../utils/memberHelper";

// â–¼ é™å®šç”¨ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ç”»åƒã®å‹å®šç¾©
type SliderNews = {
    id: string;
    top_image_isLimited?: { url: string };
};

// â–¼ é™å®šç”¨ç”»åƒ(top_image_isLimited)ã‚’å–å¾—
const sliderResponse = await client.get<MicroCMSListResponse<SliderNews>>({
    endpoint: "news",
    queries: {
        fields: ["top_image_isLimited"],
        filters: "top_image_isLimited[exists]",
        limit: 10,
    },
});

// â–¼ Vegas.jså½¢å¼ã«å¤‰æ›
const vegasImages = sliderResponse.contents.map((content) => ({
    // @ts-ignore
    src: content.top_image_isLimited.url,
}));

// â–¼ éƒ¨å“¡ã®è¨­è¨ˆå›³
type Member = {
    id: string;
    name: string;
    image: { url: string }; // é€šå¸¸ç”»åƒ
    // â–¼ è¿½åŠ : é™å®šç”¨ãƒ—ãƒ­ãƒ•ç”»åƒ
    image_isLimited?: { url: string };

    grade: any;
    parts: string | string[];
    content?: string;
    FullName?: string;
    nickname?: string;
    private_content?: string;
    SNS?: string;
};

// â–¼ éƒ¨å“¡ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ä»¶å–å¾—
const response = await client.get<MicroCMSListResponse<Member>>({
    endpoint: "members",
    queries: {
        limit: 100,
        orders: "grade",
        fields: [
            "id",
            "name",
            "image",
            "image_isLimited", // â–¼ å–å¾—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¿½åŠ 
            "grade",
            "parts",
            "content",
            "FullName",
            "nickname",
            "private_content",
            "SNS",
        ],
    },
});
---

<Layout title="LIMITED_MEMBER" isLimited={true}>
    <div id="header-placeholder"></div>

    <section id="vidual-area">
        <div id="slider-area" class="bgextend bgRLextendTrigger">
            <div class="bgappearTrigger">
                <div id="slider"></div>
            </div>
        </div>
        <h2>
            <span class="js_typing">Members Only</span><br /><span
                class="js_typing">Secret Profiles</span
            >
        </h2>
        <div class="scrolldown1"><span>Scroll</span></div>
    </section>

    <main id="main-area">
        <section id="service1">
            <h2 class="js_typing">Limited Member List</h2>
            <p style="text-align:center; margin-bottom:30px; font-size:0.9rem;">
                ã“ã“ã¯éƒ¨å“¡é™å®šãƒšãƒ¼ã‚¸ã§ã™ã€‚<br
                />éƒ¨å“¡ã«ã—ã‹è¦‹ã›ãªã„ã€Œè£ã®é¡”ã€ãŒè¦‹ã‚Œã‚‹ã‹ã‚‚â€¦ï¼Ÿ
            </p>

            <div class="sort-container">
                <ul class="sort-row">
                    <li class="filter-btn active" data-filter="all">å…¨ã¦</li>
                    <li class="filter-btn" data-filter="grade-5">5å¹´ä¼š</li>
                    <li class="filter-btn" data-filter="grade-4">4å¹´ä¼š</li>
                    <li class="filter-btn" data-filter="grade-3">3å¹´ä¼š</li>
                    <li class="filter-btn" data-filter="grade-2">2å¹´ä¼š</li>
                    <li class="filter-btn" data-filter="grade-1">1å¹´ä¼š</li>
                </ul>
                <ul class="sort-row">
                    <li class="filter-btn" data-filter="part-Vo">Vo</li>
                    <li class="filter-btn" data-filter="part-Gt">Gt</li>
                    <li class="filter-btn" data-filter="part-Ba">Ba</li>
                    <li class="filter-btn" data-filter="part-Dr">Dr</li>
                    <li class="filter-btn" data-filter="part-Key">Key</li>
                </ul>
            </div>

            <ul id="gallery" class="grid delayScroll">
                {
                    response.contents.map((member) => {
                        // å­¦å¹´ãƒ»ãƒ‘ãƒ¼ãƒˆå‡¦ç†
                        let rawGrade = Array.isArray(member.grade)
                            ? member.grade[0]
                            : member.grade;
                        let gradeNum = parseInt(
                            String(rawGrade).replace(/[^0-9]/g, ""),
                            10,
                        );
                        const schoolYear = getSchoolYear(gradeNum);

                        let rawPartsArray: string[] = [];
                        if (Array.isArray(member.parts)) {
                            rawPartsArray = member.parts;
                        } else if (member.parts) {
                            rawPartsArray = [member.parts as string];
                        }
                        const partsDisplay = rawPartsArray.join(" / ");
                        const normalizedParts = rawPartsArray.map((p) =>
                            normalizePart(p),
                        );
                        const filterClasses =
                            `grade-${schoolYear} ` +
                            normalizedParts.map((p) => `part-${p}`).join(" ");

                        // åå‰å‡¦ç†
                        const displayName = member.FullName
                            ? member.FullName
                            : member.name;
                        const subName =
                            member.FullName && member.name !== member.FullName
                                ? member.name
                                : "";

                        // â–¼â–¼â–¼ ç”»åƒã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
                        // é™å®šç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°é€šå¸¸ç”»åƒã‚’ä½¿ã†
                        const displayImage = member.image_isLimited
                            ? member.image_isLimited.url
                            : member.image.url;

                        return (
                            <li class={`item ${filterClasses}`}>
                                <div class="item-content">
                                    <a
                                        data-fancybox
                                        data-src={`#modal-${member.id}`}
                                        href="javascript:;"
                                        class="member-link"
                                    >
                                        <div class="img-box limited-border">
                                            {/* â–¼ æ±ºå®šã—ãŸç”»åƒã‚’è¡¨ç¤º */}
                                            <img
                                                src={displayImage}
                                                alt={displayName}
                                            />
                                        </div>

                                        <span class="main-name">
                                            {displayName}
                                        </span>

                                        {member.nickname && (
                                            <span class="nickname">
                                                @{member.nickname}
                                            </span>
                                        )}
                                    </a>

                                    {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
                                    <div
                                        style="display: none;"
                                        id={`modal-${member.id}`}
                                        class="member-popup"
                                    >
                                        <div class="popup-inner">
                                            <div class="popup-img-area">
                                                {/* â–¼ ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚‚æ±ºå®šã—ãŸç”»åƒã‚’è¡¨ç¤º */}
                                                <img
                                                    src={displayImage}
                                                    alt={displayName}
                                                />
                                            </div>
                                            <div class="popup-text-area">
                                                <h3 class="popup-name">
                                                    {displayName}
                                                    {subName && (
                                                        <span class="popup-fullname">
                                                            ï¼ˆ{subName}ï¼‰
                                                        </span>
                                                    )}
                                                </h3>

                                                {member.nickname && (
                                                    <p class="popup-nickname-large">
                                                        @{member.nickname}
                                                    </p>
                                                )}

                                                <div class="popup-info">
                                                    <span class="badge grade">
                                                        {schoolYear}å¹´ä¼š
                                                    </span>
                                                    <span class="badge part">
                                                        {partsDisplay}
                                                    </span>
                                                </div>

                                                {member.SNS && (
                                                    <div class="sns-links">
                                                        <a
                                                            href={member.SNS}
                                                            target="_blank"
                                                            class="sns-btn"
                                                        >
                                                            ğŸ”— SNS Check!
                                                        </a>
                                                    </div>
                                                )}

                                                <div class="popup-scroll-area">
                                                    <div class="popup-comment">
                                                        <p class="section-label">
                                                            Profile
                                                        </p>
                                                        {member.content
                                                            ? member.content
                                                            : "ç´¹ä»‹æ–‡ãªã—"}
                                                    </div>

                                                    {/* é™å®šãƒšãƒ¼ã‚¸ã®è¦‹ã›å ´ */}
                                                    {member.private_content && (
                                                        <div class="private-comment">
                                                            <p class="section-label secret">
                                                                ğŸ”’ SECRET
                                                                (Members Only)
                                                            </p>
                                                            <div class="secret-text">
                                                                {
                                                                    member.private_content
                                                                }
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        );
                    })
                }
            </ul>
        </section>
    </main>

    <script is:inline>
        document.addEventListener("DOMContentLoaded", () => {
            const buttons = document.querySelectorAll(".filter-btn");
            const items = document.querySelectorAll(".item");

            buttons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    buttons.forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");
                    const filterValue = btn.getAttribute("data-filter");

                    items.forEach((item) => {
                        if (filterValue === "all") {
                            item.style.display = "block";
                        } else {
                            if (item.classList.contains(filterValue)) {
                                item.style.display = "block";
                            } else {
                                item.style.display = "none";
                            }
                        }
                    });
                });
            });

            if (typeof $ !== "undefined" && $("[data-fancybox]").length > 0) {
                $("[data-fancybox]").fancybox({
                    touch: false,
                    autoFocus: false,
                    animationEffect: "zoom-in-out",
                });
            }
        });
    </script>

    <script is:inline define:vars={{ vegasImages }}>
        window.addEventListener("load", function () {
            // jQueryã¨VegasãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (typeof $ === "undefined" || typeof $.fn.vegas === "undefined") {
                console.error("Vegas or jQuery not loaded");
                return;
            }

            // é™å®šç”¨ç”»åƒãŒ1æšã‚‚ãªã‹ã£ãŸå ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ
            const defaultImages = [{ src: "/img/jpg/bg_main_01.jpg" }];

            // ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ã†
            const finalImages =
                vegasImages.length > 0 ? vegasImages : defaultImages;

            // Vegasã‚’é–‹å§‹
            $("#slider").vegas({
                overlay: false,
                transition: "blur",
                transitionDuration: 2000,
                delay: 10000,
                animationDuration: 20000,
                animation: "kenburns",
                slides: finalImages,
            });
        });
    </script>

    <style>
        /* ä¸€èˆ¬ãƒšãƒ¼ã‚¸ã¨ã»ã¼åŒã˜ã§ã™ãŒã€ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã‚’å«ã‚ã¦ã„ã¾ã™ */
        .sort-container {
            margin-bottom: 40px;
            text-align: center;
        }
        .sort-row {
            display: flex !important;
            justify-content: center !important;
            flex-wrap: wrap !important;
            gap: 10px !important;
            margin-bottom: 15px !important;
            list-style: none !important;
            padding: 0 !important;
        }

        .filter-btn {
            display: inline-block !important;
            width: auto !important;
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 30px;
            padding: 8px 20px;
            cursor: pointer;
            color: #fff;
            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç™½ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰ */
            transition: all 0.3s;
        }

        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        :global(body.light-mode) .filter-btn,
        :global(body.light) .filter-btn {
            color: #333;
            border-color: #999;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #b22222 !important;
            border-color: #b22222 !important;
            color: #fff !important;
        }

        :global(body.light-mode) .filter-btn:hover,
        :global(body.light-mode) .filter-btn.active,
        :global(body.light) .filter-btn:hover,
        :global(body.light) .filter-btn.active {
            background: #0066cc !important;
            border-color: #0066cc !important;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            margin: 0 auto;
            list-style: none;
            max-width: 1200px;
        }
        .item {
            position: relative;
            display: block;
            width: 180px;
            margin-bottom: 20px;
            transition: opacity 0.3s ease;
        }
        .item-content {
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .img-box {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: border-color 0.3s;
            background: #333;
        }
        .img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .item:hover .img-box {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .main-name {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: #fff; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç™½ */
            font-size: 1rem;
            transition: color 0.3s;
        }

        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        :global(body.light-mode) .main-name,
        :global(body.light) .main-name {
            color: #333;
        }

        .nickname {
            display: block;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 2px;
        }

        .member-popup {
            display: none;
            width: 90%;
            max-width: 800px;
            background: #fff;
            border-radius: 10px;
            padding: 0;
            color: #333;
            overflow: hidden;
        }
        .popup-inner {
            display: flex;
            flex-wrap: wrap;
        }
        .popup-img-area {
            width: 40%;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .popup-img-area img {
            width: 100%;
            height: auto;
            border-radius: 50%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
        }

        .popup-text-area {
            width: 60%;
            padding: 30px;
            text-align: left;
            display: flex;
            flex-direction: column;
        }

        .popup-name {
            font-size: 1.8rem;
            font-weight: bold;
            border-bottom: 2px solid #b22222;
            padding-bottom: 5px;
            margin-bottom: 5px;
            display: inline-block;
            font-family: "Oswald", sans-serif;
            color: #333;
        }

        :global(body.light-mode) .popup-name,
        :global(body.light) .popup-name {
            border-bottom-color: #0066cc;
        }

        .popup-fullname {
            font-size: 1rem;
            color: #555;
            font-weight: normal;
            margin-left: 10px;
        }
        .popup-nickname-large {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .popup-info {
            margin-bottom: 15px;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-right: 5px;
            color: #fff;
            font-weight: bold;
        }
        .badge.grade {
            background-color: #333;
        }
        .badge.part {
            background-color: #b22222;
        }

        :global(body.light-mode) .badge.part,
        :global(body.light) .badge.part {
            background-color: #0066cc;
        }

        .sns-links {
            margin-bottom: 20px;
        }
        .sns-btn {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(45deg, #1da1f2, #833ab4);
            transition: opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .sns-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .popup-scroll-area {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .section-label {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            display: inline-block;
        }

        .section-label.secret {
            color: #d9534f;
            font-weight: bold;
            border-color: #d9534f;
            margin-top: 25px;
        }
        .private-comment {
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #d9534f;
            position: relative;
        }
        .private-comment::before {
            content: "TOP SECRET";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #d9534f;
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .secret-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        .popup-comment {
            font-size: 1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 10px;
            color: #333;
        }

        @media only screen and (max-width: 768px) {
            .grid {
                gap: 15px;
            }
            .item {
                width: 45%;
                max-width: 160px;
            }
            .popup-inner {
                flex-direction: column;
            }
            .popup-img-area,
            .popup-text-area {
                width: 100%;
            }
            .popup-img-area img {
                width: 150px;
            }
        }
    </style>
</Layout>
