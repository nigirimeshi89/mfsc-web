---
// src/pages/limited/schedule.astro
import Layout from "../../layouts/Layout.astro";
import { client } from "../../lib/microcms";
import type { MicroCMSListResponse } from "../../lib/microcms";

// ‚ñº ËøΩÂä†: ÈôêÂÆöÁî®„Çπ„É©„Ç§„Éâ„Ç∑„Éß„ÉºÁîªÂÉè„ÅÆÂûãÂÆöÁæ©
type SliderNews = {
    id: string;
    top_image_isLimited?: { url: string };
};

// ‚ñº ËøΩÂä†: ÈôêÂÆöÁî®ÁîªÂÉè(top_image_isLimited)„ÇíÂèñÂæó
const sliderResponse = await client.get<MicroCMSListResponse<SliderNews>>({
    endpoint: "news",
    queries: {
        fields: ["top_image_isLimited"], // ÈôêÂÆöÁî®„Éï„Ç£„Éº„É´„Éâ„ÇíÊåáÂÆö
        filters: "top_image_isLimited[exists]", // ÁîªÂÉè„Åå„ÅÇ„ÇãË®ò‰∫ã„Å†„Åë
        limit: 10,
    },
});

// ‚ñº ËøΩÂä†: Vegas.jsÂΩ¢Âºè„Å´Â§âÊèõ
const vegasImages = sliderResponse.contents.map((content) => ({
    // @ts-ignore
    src: content.top_image_isLimited.url,
}));

// ‚ñº „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„ÅÆË®≠Ë®àÂõ≥
type Schedule = {
    id: string;
    title: string;
    month: string[];
    type: string[];
    timing: string;
    archives?: string;
    url?: string;
    isLimited?: boolean;
};

// ‚ñº „Éá„Éº„Çø„ÇíÂèñÂæó
const response = await client.get<MicroCMSListResponse<Schedule>>({
    endpoint: "schedules",
    queries: { limit: 100 },
});

// ‚ñº Êúà„ÅÆ‰∏¶„Å≥È†Ü
const monthOrder = [
    "4Êúà",
    "5Êúà",
    "6Êúà",
    "7Êúà",
    "8Êúà",
    "9Êúà",
    "10Êúà",
    "11Êúà",
    "12Êúà",
    "1Êúà",
    "2Êúà",
    "3Êúà",
];

// ‚ñº „Éá„Éº„Çø„ÇíÊúà„Åî„Å®„Å´ÊåØ„ÇäÂàÜ„Åë
const groupedSchedules: Record<string, Schedule[]> = {};
monthOrder.forEach((m) => (groupedSchedules[m] = []));

response.contents.forEach((s) => {
    let m = s.month && s.month.length > 0 ? s.month[0] : "„Åù„ÅÆ‰ªñ";
    if (!m.includes("Êúà")) m = m + "Êúà";

    if (groupedSchedules[m]) {
        groupedSchedules[m].push(s);
    } else {
        if (!groupedSchedules["Other"]) groupedSchedules["Other"] = [];
        groupedSchedules["Other"].push(s);
    }
});

// ‚ñº‚ñº‚ñº ‰∏¶„Å≥Êõø„Åà„ÅÆ„Åü„ÇÅ„ÅÆ„Çπ„Ç≥„Ç¢Ë®àÁÆóÈñ¢Êï∞Ôºà‰øÆÊ≠£ÁâàÔºâ ‚ñº‚ñº‚ñº
const getSortScore = (event: Schedule) => {
    // ‚òÖ‰øÆÊ≠£„Éù„Ç§„É≥„ÉàÔºötiming„ÅåÁÑ°„ÅÑ(undefined)Â†¥Âêà„ÅØÁ©∫ÊñáÂ≠ó„Å´„Åô„ÇãÂÆâÂÖ®Ë£ÖÁΩÆ
    const timingText = event.timing || "";

    // 1. ÊôÇÊúü„Çπ„Ç≥„Ç¢ÔºàÂ∞è„Åï„ÅÑ„Åª„Å©‰∏äÔºâ
    let timingScore = 99;
    if (timingText.includes("‰∏äÊó¨")) timingScore = 10;
    else if (timingText.includes("‰∏≠Êó¨")) timingScore = 20;
    else if (timingText.includes("‰∏ãÊó¨")) timingScore = 30;

    // 2. Á®ÆÈ°û„Çπ„Ç≥„Ç¢ÔºàÂ∞è„Åï„ÅÑ„Åª„Å©‰∏äÔºâ
    // Â≠¶ÂÜÖ(‰∏ÄËà¨)=1, Â≠¶ÂÜÖ(ÈôêÂÆö)=2, Ê∏âÂ§ñ=3, „Åù„ÅÆ‰ªñ=4
    let typeScore = 4;
    const typeName = event.type && event.type.length > 0 ? event.type[0] : "";

    if (typeName.includes("Â≠¶ÂÜÖ")) {
        typeScore = event.isLimited ? 2 : 1;
    } else if (typeName.includes("Ê∏âÂ§ñ")) {
        typeScore = 3;
    }

    return { timingScore, typeScore };
};

// ‚ñº „Çø„Ç§„Éà„É´„Åß„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å§„Å§„ÄÅ‰ª£Ë°®„Ç§„Éô„É≥„Éà„Åß„ÇΩ„Éº„Éà„Åô„ÇãÈñ¢Êï∞
const groupAndSortEvents = (events: Schedule[]) => {
    const map = new Map<string, Schedule[]>();
    events.forEach((e) => {
        const existing = map.get(e.title) || [];
        existing.push(e);
        map.set(e.title, existing);
    });

    const groups = Array.from(map.entries()).map(([title, items]) => {
        const representative = items[0];
        return {
            title,
            items,
            mainType: representative.type ? representative.type[0] : null,
            sortKey: getSortScore(representative),
        };
    });

    groups.sort((a, b) => {
        const diffTiming = a.sortKey.timingScore - b.sortKey.timingScore;
        if (diffTiming !== 0) return diffTiming;
        return a.sortKey.typeScore - b.sortKey.typeScore;
    });

    return groups;
};
---

<Layout title="LIMITED_SCHEDULE" isLimited={true}>
    <div id="header-placeholder"></div>

    <section id="vidual-area">
        <div id="slider-area" class="bgextend bgRLextendTrigger">
            <div class="bgappearTrigger">
                <div id="slider"></div>
            </div>
        </div>
        <h2>
            <span class="js_typing">Members Only</span><br /><span
                class="js_typing">Secret Schedule</span
            >
        </h2>
        <dl>
            <dt>Follow Us</dt>
            <dd>
                <ul>
                    <li>
                        <a href="https://x.com/momotenguitar">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 1200 1227"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"
                                    fill="white"></path>
                            </svg>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.instagram.com/mfsc_modern/?hl=ja">
                            <img
                                src="/img/main/ico_insta.svg"
                                alt="Instagram"
                            />
                        </a>
                    </li>
                </ul>
            </dd>
        </dl>
        <div class="scrolldown1"><span>Scroll</span></div>
    </section>

    <main id="main-area">
        <section id="service1">
            <h2 class="js_typing">INTERNAL SCHEDULE</h2>
            <p style="text-align:center; margin-bottom:40px;">
                ÈÉ®Âì°Áî®„Çπ„Ç±„Ç∏„É•„Éº„É´ÔºàÂÖ®‰ΩìÔºãÂÜÖÈÉ®‰∫àÂÆöÔºâ„Åß„Åô„ÄÇ<br />
                Âêå„Åò„Ç§„Éô„É≥„ÉàÂêç„ÅÆ„ÇÇ„ÅÆ„ÅØ„Åæ„Å®„ÇÅ„Å¶Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
            </p>

            <section class="details-wrapper">
                <div class="schedule-container">
                    {
                        monthOrder.map((month) => {
                            const groupedEvents = groupAndSortEvents(
                                groupedSchedules[month],
                            );

                            return (
                                <div class="month-section">
                                    <div class="month-header">
                                        <h3>{month}</h3>
                                    </div>
                                    <div class="month-body">
                                        {groupedEvents.length > 0 ? (
                                            <ul class="event-list">
                                                {groupedEvents.map((group) => (
                                                    <li class="event-group-item">
                                                        <div class="group-header">
                                                            <h4 class="group-title">
                                                                {group.title}
                                                            </h4>
                                                            {group.mainType && (
                                                                <span class="badge">
                                                                    {
                                                                        group.mainType
                                                                    }
                                                                </span>
                                                            )}
                                                        </div>

                                                        <div class="group-content">
                                                            {group.items.map(
                                                                (event) => (
                                                                    <div
                                                                        class={`sub-event-row ${event.isLimited ? "is-limited" : ""}`}
                                                                    >
                                                                        <div class="sub-event-info">
                                                                            {event.url ? (
                                                                                <a
                                                                                    href={
                                                                                        event.url
                                                                                    }
                                                                                    target="_blank"
                                                                                    rel="noopener noreferrer"
                                                                                    class="timing-link"
                                                                                >
                                                                                    <span class="timing link-active">
                                                                                        {
                                                                                            event.timing
                                                                                        }{" "}
                                                                                        <span class="link-icon">
                                                                                            üîó
                                                                                        </span>
                                                                                    </span>
                                                                                </a>
                                                                            ) : (
                                                                                <span class="timing">
                                                                                    {
                                                                                        event.timing
                                                                                    }
                                                                                </span>
                                                                            )}

                                                                            {event.isLimited && (
                                                                                <span class="mini-badge">
                                                                                    üîí
                                                                                </span>
                                                                            )}
                                                                        </div>

                                                                        {event.archives && (
                                                                            <div class="sub-event-detail">
                                                                                <button
                                                                                    type="button"
                                                                                    class="accordion-trigger mini-trigger"
                                                                                >
                                                                                    Ë©≥Á¥∞
                                                                                    ‚ñº
                                                                                </button>
                                                                                <div
                                                                                    class="accordion-content"
                                                                                    style="display: none;"
                                                                                >
                                                                                    <div
                                                                                        class="desc-inner"
                                                                                        set:html={
                                                                                            event.archives
                                                                                        }
                                                                                    />
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ),
                                                            )}
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <p class="no-event">
                                                ‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                                            </p>
                                        )}
                                    </div>
                                </div>
                            );
                        })
                    }
                </div>
            </section>
        </section>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const triggers = document.querySelectorAll(".accordion-trigger");

            triggers.forEach((trigger) => {
                trigger.addEventListener("click", (e) => {
                    const target = e.currentTarget;
                    if (!(target instanceof HTMLElement)) return;

                    target.classList.toggle("active");
                    const content = target.nextElementSibling;

                    if (content instanceof HTMLElement) {
                        if (content.style.display === "none") {
                            content.style.display = "block";
                            target.textContent = "Ë©≥Á¥∞ ‚ñ≤";
                        } else {
                            content.style.display = "none";
                            target.textContent = "Ë©≥Á¥∞ ‚ñº";
                        }
                    }
                });
            });
        });
    </script>

    <script is:inline define:vars={{ vegasImages }}>
        window.addEventListener("load", function () {
            // jQuery„Å®Vegas„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (typeof $ === "undefined" || typeof $.fn.vegas === "undefined") {
                console.error("Vegas or jQuery not loaded");
                return;
            }

            // ÈôêÂÆöÁî®ÁîªÂÉè„Åå1Êûö„ÇÇ„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁîªÂÉèÔºà„ÅäÂ•Ω„Åç„Å™ÁîªÂÉè„Éë„Çπ„Å´Â§â„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
            const defaultImages = [{ src: "/img/jpg/bg_main_01.jpg" }];

            // ÁîªÂÉè„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÑ„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà„Çí‰Ωø„ÅÜ
            const finalImages =
                vegasImages.length > 0 ? vegasImages : defaultImages;

            // ‚òÖ‰øÆÊ≠£: destroy„ÅØÂâäÈô§„Åó„Åæ„Åó„Åü

            // Vegas„ÇíÈñãÂßã
            $("#slider").vegas({
                overlay: false, // Á∂≤Êéõ„Åë„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàÂøÖË¶Å„Å™„Çâ true „Å™„Å©„ÅÆ„Éë„Çπ„ÇíÊåáÂÆöÔºâ
                transition: "blur",
                transitionDuration: 2000,
                delay: 10000,
                animationDuration: 20000,
                animation: "kenburns",
                slides: finalImages,
            });
        });
    </script>

    <style>
        .schedule-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .month-section {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #555;
            padding-bottom: 30px;
        }
        .month-header {
            width: 80px;
            flex-shrink: 0;
            padding-top: 5px;
        }
        .month-header h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            font-family: "Oswald", sans-serif;
            border-bottom: 3px solid #fff;
            display: inline-block;
        }
        .month-body {
            flex-grow: 1;
            padding-left: 20px;
        }
        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .event-group-item {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
        }
        .group-header {
            background: #222;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
        }
        .group-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            margin: 0;
        }
        .group-content {
            padding: 10px 15px;
        }
        .sub-event-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #444;
        }
        .sub-event-row:last-child {
            border-bottom: none;
        }
        .sub-event-row.is-limited {
            background: rgba(217, 83, 79, 0.05);
            margin: 0 -15px;
            padding: 10px 15px;
        }
        .sub-event-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .timing {
            font-weight: bold;
            color: #aaa;
            font-size: 0.95rem;
        }
        .timing.link-active {
            color: #4da6ff;
            border-bottom: 1px dashed #4da6ff;
        }
        .timing-link {
            text-decoration: none;
        }
        .sub-event-detail {
            flex-shrink: 0;
            margin-left: 15px;
            text-align: right;
            max-width: 60%;
        }
        .mini-trigger {
            background: transparent;
            border: 1px solid #666;
            color: #888;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mini-trigger:hover {
            border-color: #aaa;
            color: #fff;
        }
        .accordion-content {
            margin-top: 10px;
            text-align: left;
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
        }
        .badge {
            background: #b22222;
            color: #fff;
            padding: 2px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }
        .mini-badge {
            font-size: 0.8rem;
            cursor: help;
        }
        .no-event {
            color: #666;
            font-size: 0.9rem;
            padding-top: 10px;
        }

        /* „É©„Ç§„Éà„É¢„Éº„ÉâÂØæÂøú */
        :global(body.light-mode) .month-section,
        :global(body.light) .month-section {
            border-bottom-color: #ddd;
        }
        :global(body.light-mode) .month-header h3,
        :global(body.light) .month-header h3 {
            color: #333;
            border-bottom-color: #333;
        }
        :global(body.light-mode) .event-group-item,
        :global(body.light) .event-group-item {
            background: #fff;
            border-color: #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        :global(body.light-mode) .group-header,
        :global(body.light) .group-header {
            background: #f0f0f0;
            border-bottom-color: #ddd;
        }
        :global(body.light-mode) .group-title,
        :global(body.light) .group-title {
            color: #333;
        }
        :global(body.light-mode) .badge,
        :global(body.light) .badge {
            background: #0066cc;
        }
        :global(body.light-mode) .sub-event-row,
        :global(body.light) .sub-event-row {
            border-bottom-color: #eee;
        }
        :global(body.light-mode) .sub-event-row.is-limited,
        :global(body.light) .sub-event-row.is-limited {
            background: rgba(255, 153, 0, 0.05);
        }
        :global(body.light-mode) .timing,
        :global(body.light) .timing {
            color: #555;
        }
        :global(body.light-mode) .timing.link-active,
        :global(body.light) .timing.link-active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }
        :global(body.light-mode) .accordion-content,
        :global(body.light) .accordion-content {
            background: #f9f9f9;
            color: #555;
        }

        @media (max-width: 768px) {
            .month-section {
                flex-direction: column;
            }
            .month-header {
                width: 100%;
                margin-bottom: 15px;
                border-bottom: none;
            }
            .month-header h3 {
                border-bottom-width: 2px;
            }
            .month-body {
                padding-left: 0;
            }
            .sub-event-row {
                flex-wrap: wrap;
            }
            .sub-event-detail {
                width: 100%;
                margin-left: 0;
                margin-top: 5px;
                max-width: 100%;
                text-align: left;
            }
        }
    </style>
</Layout>
