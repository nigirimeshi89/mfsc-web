---
// src/pages/member.astro
import Layout from "../layouts/Layout.astro";

// ▼ 共通ファイルから読み込み
import { client } from "../lib/microcms";
import type { MicroCMSListResponse } from "../lib/microcms";
import { getSchoolYear, normalizePart } from "../utils/memberHelper";

// ▼ 追加: ニュース画像の型定義（スライドショー用）
type News = {
    id: string;
    title: string;
    date: string;
    url?: string;
    top_image?: { url: string };
};

// ▼ 追加: スライドショー用画像の取得
const sliderResponse = await client.get<MicroCMSListResponse<News>>({
    endpoint: "news",
    queries: {
        fields: ["top_image"],
        filters: "top_image[exists]",
        limit: 10,
    },
});

// ▼ 追加: Vegas.js形式に変換
const vegasImages = sliderResponse.contents.map((content) => ({
    // @ts-ignore
    src: content.top_image.url,
}));

// ▼ 部員の設計図
type Member = {
    id: string;
    name: string;
    image: { url: string };
    grade: any;
    parts: string | string[];
    content?: string;
};

// ▼ 部員データを全件取得
const response = await client.get<MicroCMSListResponse<Member>>({
    endpoint: "members",
    queries: {
        limit: 100,
        orders: "grade",
        fields: ["id", "name", "image", "grade", "parts", "content"],
    },
});
---

<Layout title="MEMBER">
    <div id="header-placeholder"></div>

    <section id="vidual-area">
        <div id="slider-area" class="bgextend bgRLextendTrigger">
            <div class="bgappearTrigger">
                <div id="slider"></div>
            </div>
        </div>
        <h2>
            <span class="js_typing">Modern Folk Song Club</span><br /><span
                class="js_typing">Members</span
            >
        </h2>
        <div class="scrolldown1"><span>Scroll</span></div>
    </section>

    <main id="main-area">
        <section id="service1">
            <h2>Member</h2>

            <div class="sort-container">
                <ul class="sort-row">
                    <li class="filter-btn active" data-filter="all">全て</li>
                    <li class="filter-btn" data-filter="grade-4">4年会</li>
                    <li class="filter-btn" data-filter="grade-3">3年会</li>
                    <li class="filter-btn" data-filter="grade-2">2年会</li>
                    <li class="filter-btn" data-filter="grade-1">1年会</li>
                </ul>
                <ul class="sort-row">
                    <li class="filter-btn" data-filter="part-Vo">ボーカル</li>
                    <li class="filter-btn" data-filter="part-Gt">ギター</li>
                    <li class="filter-btn" data-filter="part-Ba">ベース</li>
                    <li class="filter-btn" data-filter="part-Dr">ドラム</li>
                    <li class="filter-btn" data-filter="part-Key">
                        キーボード
                    </li>
                </ul>
            </div>

            <ul id="gallery" class="grid delayScroll">
                {
                    response.contents.map((member) => {
                        // 学年処理
                        let rawGrade = Array.isArray(member.grade)
                            ? member.grade[0]
                            : member.grade;
                        let gradeNum = parseInt(
                            String(rawGrade).replace(/[^0-9]/g, ""),
                            10,
                        );
                        const schoolYear = getSchoolYear(gradeNum);

                        // パート処理
                        let rawPartsArray: string[] = [];
                        if (Array.isArray(member.parts)) {
                            rawPartsArray = member.parts;
                        } else if (member.parts) {
                            rawPartsArray = [member.parts as string];
                        }

                        // 表示用
                        const partsDisplay = rawPartsArray.join(" / ");
                        // 絞り込み用（正規化）
                        const normalizedParts = rawPartsArray.map((p) =>
                            normalizePart(p),
                        );
                        const filterClasses =
                            `grade-${schoolYear} ` +
                            normalizedParts.map((p) => `part-${p}`).join(" ");

                        return (
                            <li class={`item ${filterClasses}`}>
                                <div class="item-content">
                                    <a
                                        data-fancybox
                                        data-src={`#modal-${member.id}`}
                                        href="javascript:;"
                                        class="member-link"
                                    >
                                        <div class="img-box">
                                            <img
                                                src={member.image.url}
                                                alt={member.name}
                                            />
                                        </div>
                                        <span>{member.name}</span>
                                    </a>

                                    <div
                                        style="display: none;"
                                        id={`modal-${member.id}`}
                                        class="member-popup"
                                    >
                                        <div class="popup-inner">
                                            <div class="popup-img-area">
                                                <img
                                                    src={member.image.url}
                                                    alt={member.name}
                                                />
                                            </div>
                                            <div class="popup-text-area">
                                                <h3 class="popup-name">
                                                    {member.name}
                                                </h3>
                                                <div class="popup-info">
                                                    <span class="badge grade">
                                                        {schoolYear}年会
                                                    </span>
                                                    <span class="badge part">
                                                        {partsDisplay}
                                                    </span>
                                                </div>

                                                {member.content ? (
                                                    <div class="popup-comment">
                                                        {member.content}
                                                    </div>
                                                ) : (
                                                    <div
                                                        class="popup-comment"
                                                        style="color:#ccc;"
                                                    >
                                                        <p>紹介文なし</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        );
                    })
                }
            </ul>
        </section>
    </main>

    <script
        is:inline
        src="https://cdn.jsdelivr.net/npm/web-animations-js@2.3.2/web-animations.min.js"
    ></script>
    <script
        is:inline
        src="https://cdn.jsdelivr.net/npm/muuri@0.8.0/dist/muuri.min.js"
    ></script>

    <script is:inline>
        document.addEventListener("DOMContentLoaded", () => {
            // Fancyboxの初期化
            if (typeof $ !== "undefined" && $("[data-fancybox]").length > 0) {
                $("[data-fancybox]").fancybox({
                    touch: false,
                    autoFocus: false,
                    animationEffect: "zoom-in-out",
                });
            }

            // ▼ フィルタリングロジックについて
            // Muuriライブラリを読み込んだため、もしmain.js側で自動的にフィルタリングが動く場合は、
            // 以下の手動フィルタリングコードは不要（削除してもよい）になります。
            // ひとまず競合を避けるため、手動コードも残していますが、
            // 動きがおかしい場合はこの下から「ここまで」の間を削除してください。

            const buttons = document.querySelectorAll(".filter-btn");
            const items = document.querySelectorAll(".item");

            buttons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    buttons.forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");
                    const filterValue = btn.getAttribute("data-filter");

                    items.forEach((item) => {
                        if (filterValue === "all") {
                            item.style.display = "block";
                        } else {
                            if (item.classList.contains(filterValue)) {
                                item.style.display = "block";
                            } else {
                                item.style.display = "none";
                            }
                        }
                    });
                });
            });
            // ▲ 手動フィルタリングここまで ▲
        });
    </script>

    <script is:inline define:vars={{ vegasImages }}>
        // jQuery ($) を使わず、純粋なJSでロード完了を待ちます
        window.addEventListener("load", function () {
            // ロード完了後、jQueryが使えるかチェック
            if (typeof $ === "undefined" || typeof $.fn.vegas === "undefined") {
                console.error("Vegas or jQuery not loaded");
                return;
            }

            // デフォルト画像（取得できなかった場合のフォールバック）
            const defaultImages = [{ src: "/img/jpg/bg_main_01.jpg" }];

            // microCMSの画像があればそれを使い、なければデフォルトを使う
            const finalImages =
                vegasImages.length > 0 ? vegasImages : defaultImages;

            // Vegasを開始
            $("#slider").vegas({
                overlay: false,
                transition: "blur",
                transitionDuration: 2000,
                delay: 10000,
                animationDuration: 20000,
                animation: "kenburns",
                slides: finalImages,
            });
        });
    </script>

    <style>
        /* ▼▼▼ 追加修正：ヘッダーのクリックを確実にするための設定 ▼▼▼ */
        #header-placeholder {
            pointer-events: none !important;
            position: relative;
            z-index: -1;
        }

        :global(#header),
        :global(header),
        :global(.header) {
            z-index: 2147483647 !important; /* 最前面に固定 */
            position: fixed !important;
            pointer-events: auto !important;
        }

        :global(#header a),
        :global(header a),
        :global(.header a),
        :global(#search-btn),
        :global(.search-btn) {
            pointer-events: auto !important;
            z-index: 2147483647 !important;
            cursor: pointer !important; /* カーソルも指マークに強制 */
        }

        #vidual-area {
            position: relative;
            z-index: 1 !important;
            pointer-events: none; /* 下の要素（ヘッダー含む）を通す */
        }

        #slider-area {
            pointer-events: none;
            z-index: 0;
        }

        #vidual-area .scrolldown1 {
            pointer-events: auto; /* スクロールボタンは押せるように戻す */
            cursor: pointer;
        }
        /* ▲▲▲ 追加修正ここまで ▲▲▲ */

        .sort-container {
            margin-bottom: 40px;
            text-align: center;
        }
        .sort-row {
            display: flex !important;
            justify-content: center !important;
            flex-wrap: wrap !important;
            gap: 10px !important;
            margin-bottom: 15px !important;
            list-style: none !important;
            padding: 0 !important;
        }

        .filter-btn {
            display: inline-block !important;
            width: auto !important;
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 30px;
            padding: 8px 20px;
            cursor: pointer;
            color: #fff;
            /* ダークモード時の文字色（白） */
            transition: all 0.3s;
        }

        /* ▼▼▼ ライトモード：フィルタボタン ▼▼▼ */
        :global(body.light-mode) .filter-btn,
        :global(body.light) .filter-btn {
            color: #333;
            /* 文字を黒に！ */
            border-color: #999;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #b22222 !important;
            border-color: #b22222 !important;
            color: #fff !important;
        }

        /* ▼▼▼ ライトモード：アクティブボタン（青） ▼▼▼ */
        :global(body.light-mode) .filter-btn:hover,
        :global(body.light-mode) .filter-btn.active,
        :global(body.light) .filter-btn:hover,
        :global(body.light) .filter-btn.active {
            background: #0066cc !important;
            border-color: #0066cc !important;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            margin: 0 auto;
            list-style: none;
            max-width: 1200px;
            position: relative;
        }

        .item {
            position: relative;
            display: block;
            width: 180px;
            margin-bottom: 20px;
            transition: opacity 0.3s ease;
        }

        .item-content {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
        }
        .img-box {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: border-color 0.3s;
            background: #333;
        }
        .img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            vertical-align: bottom;
        }
        .item:hover .img-box {
            border-color: #b22222;
        }
        /* ▼▼▼ ライトモード：画像のボーダー（青） ▼▼▼ */
        :global(body.light-mode) .item:hover .img-box,
        :global(body.light) .item:hover .img-box {
            border-color: #0066cc;
        }

        .item span {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: #fff; /* ダークモード時の文字色（白） */
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        /* ▼▼▼ ライトモード：名前の文字色（黒） ▼▼▼ */
        :global(body.light-mode) .item span,
        :global(body.light) .item span {
            color: #333;
        }

        .member-popup {
            display: none;
            width: 90%;
            max-width: 800px;
            background: #fff;
            border-radius: 10px;
            padding: 0;
            color: #333;
            overflow: hidden;
        }
        .popup-inner {
            display: flex;
            flex-wrap: wrap;
        }
        .popup-img-area {
            width: 40%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .popup-img-area img {
            width: 100%;
            height: auto;
            border-radius: 50%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .popup-text-area {
            width: 60%;
            padding: 30px;
            text-align: left;
        }
        .popup-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #b22222;
            padding-bottom: 10px;
            display: inline-block;
            font-family: "Oswald", sans-serif;
            color: #333;
        }
        /* ▼▼▼ ライトモード：ポップアップ名の線（青） ▼▼▼ */
        :global(body.light-mode) .popup-name,
        :global(body.light) .popup-name {
            border-bottom-color: #0066cc;
        }

        .popup-info {
            margin-bottom: 20px;
        }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-right: 5px;
            color: #fff;
            font-weight: bold;
        }
        .badge.grade {
            background-color: #333;
        }
        .badge.part {
            background-color: #b22222;
        }
        /* ▼▼▼ ライトモード：バッジの色（青） ▼▼▼ */
        :global(body.light-mode) .badge.part,
        :global(body.light) .badge.part {
            background-color: #0066cc;
        }

        .popup-comment {
            font-size: 1rem;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333; /* 明示的に黒 */
        }

        @media only screen and (max-width: 768px) {
            .grid {
                gap: 15px;
            }
            .item {
                width: 45%;
                max-width: 160px;
            }
            .item span {
                font-size: 0.8rem;
            }
            .member-popup {
                max-width: 95%;
            }
            .popup-img-area {
                width: 100%;
                padding: 30px;
            }
            .popup-img-area img {
                width: 150px;
            }
            .popup-text-area {
                width: 100%;
                padding: 20px;
            }
            .popup-name {
                font-size: 1.5rem;
            }
        }
    </style>
</Layout>
